library(MAESTRO)
library(aricode)
library(cluster)
library(scales)
library(lawstat)
library(RColorBrewer)
library(chromVAR)
ncol <- brewer.pal(8,"Set1")

# NMI bench marking
celltype <- c("GSM1817207","GSM1876022","GSM2083780","GSM2243034","GSM2243040","GSM2386582","GSM2439074","GSM2476338","GSM2692563","GSM2898847")
celltypename <- c("Neural crest","Smooth Muscle","Macrophage","pDC","DC","ESC","Erythroblast","Melanocyte","Epithelial","Cardiomyocyte")
clusters <- rev(hue_pal()(10))

MAESTRO1 <- readRDS('clustering_benchmark_methods_simulated_data/MAESTRO/10000_merged_MAESTRO_SeuratObj.rds')
MAESTRO2 <- readRDS('clustering_benchmark_methods_simulated_data/MAESTRO/5000_merged_MAESTRO_SeuratObj.rds')
MAESTRO3 <- readRDS('clustering_benchmark_methods_simulated_data/MAESTRO/2500_merged_MAESTRO_SeuratObj.rds')
MAESTRO4 <- readRDS('clustering_benchmark_methods_simulated_data/MAESTRO/1000_merged_MAESTRO_SeuratObj.rds')
MAESTRO1_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(MAESTRO1$umap@cell.embeddings)), from = celltype, to = clusters)
MAESTRO2_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(MAESTRO2$umap@cell.embeddings)), from = celltype, to = clusters)
MAESTRO3_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(MAESTRO3$umap@cell.embeddings)), from = celltype, to = clusters)
MAESTRO4_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(MAESTRO4$umap@cell.embeddings)), from = celltype, to = clusters)
MAESTRO1_NMI <- NMI(gsub("\\_.*","",rownames(MAESTRO1@meta.data)),as.numeric(MAESTRO1$seurat_clusters)) 
MAESTRO2_NMI <- NMI(gsub("\\_.*","",rownames(MAESTRO2@meta.data)),as.numeric(MAESTRO2$seurat_clusters))
MAESTRO3_NMI <- NMI(gsub("\\_.*","",rownames(MAESTRO3@meta.data)),as.numeric(MAESTRO3$seurat_clusters))
MAESTRO4_NMI <- NMI(gsub("\\_.*","",rownames(MAESTRO4@meta.data)),as.numeric(MAESTRO4$seurat_clusters))
pdf("NMI_MAESTRO_LSI.pdf",width=13,height=3.25)
par(mfrow=c(1,4),omi=c(0.05,0.1,0.05,1))
plot(MAESTRO1$umap@cell.embeddings[,1], MAESTRO1$umap@cell.embeddings[,2], xlab="UMAP_1", ylab="UMAP_2", col=MAESTRO1_col,main="LSI 10000",pch=20);legend("topleft",paste0("NMI = ",round(MAESTRO1_NMI,3)),box.lty=0)
plot(MAESTRO2$umap@cell.embeddings[,1], MAESTRO2$umap@cell.embeddings[,2], xlab="UMAP_1", ylab="UMAP_2", col=MAESTRO2_col,main="LSI 5000",pch=20);legend("topleft",paste0("NMI = ",round(MAESTRO2_NMI,3)),box.lty=0)
plot(MAESTRO3$umap@cell.embeddings[,1], MAESTRO3$umap@cell.embeddings[,2], xlab="UMAP_1", ylab="UMAP_2", col=MAESTRO3_col,main="LSI 2500",pch=20);legend("topleft",paste0("NMI = ",round(MAESTRO3_NMI,3)),box.lty=0)
plot(MAESTRO4$umap@cell.embeddings[,1], MAESTRO4$umap@cell.embeddings[,2], xlab="UMAP_1", ylab="UMAP_2", col=MAESTRO4_col,main="LSI 1000",pch=20);legend("topleft",paste0("NMI = ",round(MAESTRO4_NMI,3)),box.lty=0)
legend(par('usr')[2]+0.1, par('usr')[4], bty='n', xpd=NA, legend=celltypename, pch=20, col=clusters, box.lty=0)
dev.off()

cisTopic1 <- readRDS('clustering_benchmark_methods_simulated_data/cisTopic/10000_merged_cisTopic.rds');cisTopic1_cluster <- readRDS('cisTopic/10000_merged_cisTopic_cluster.rds')
cisTopic2 <- readRDS('clustering_benchmark_methods_simulated_data/cisTopic/5000_merged_cisTopic.rds');cisTopic2_cluster <- readRDS('cisTopic/5000_merged_cisTopic_cluster.rds')
cisTopic3 <- readRDS('clustering_benchmark_methods_simulated_data/cisTopic/2500_merged_cisTopic.rds');cisTopic3_cluster <- readRDS('cisTopic/2500_merged_cisTopic_cluster.rds')
cisTopic4 <- readRDS('clustering_benchmark_methods_simulated_data/cisTopic/1000_merged_cisTopic.rds');cisTopic4_cluster <- readRDS('cisTopic/1000_merged_cisTopic_cluster.rds')
cisTopic1_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(cisTopic1@dr$cell$Umap)), from = celltype, to = clusters)
cisTopic2_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(cisTopic2@dr$cell$Umap)), from = celltype, to = clusters)
cisTopic3_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(cisTopic3@dr$cell$Umap)), from = celltype, to = clusters)
cisTopic4_col <- plyr::mapvalues(x = gsub("\\_.*","",rownames(cisTopic4@dr$cell$Umap)), from = celltype, to = clusters)
cisTopic1_NMI <- NMI(gsub("\\_.*","",names(cisTopic1_cluster)),as.numeric(cisTopic1_cluster)) 
cisTopic2_NMI <- NMI(gsub("\\_.*","",names(cisTopic2_cluster)),as.numeric(cisTopic2_cluster))
cisTopic3_NMI <- NMI(gsub("\\_.*","",names(cisTopic3_cluster)),as.numeric(cisTopic3_cluster))
cisTopic4_NMI <- NMI(gsub("\\_.*","",names(cisTopic4_cluster)),as.numeric(cisTopic4_cluster))
pdf("NMI_cisTopic.pdf",width=13,height=3.25)
par(mfrow=c(1,4),omi=c(0.05,0.1,0.05,1))
plot(cisTopic1@dr$cell$Umap[,1], cisTopic1@dr$cell$Umap[,2], xlab="UMAP_1", ylab="UMAP_2", col=cisTopic1_col,main="cisTopic 10000",pch=20);legend("topright",paste0("NMI = ",round(cisTopic1_NMI,3)),box.lty=0)
plot(cisTopic2@dr$cell$Umap[,1], cisTopic2@dr$cell$Umap[,2], xlab="UMAP_1", ylab="UMAP_2", col=cisTopic2_col,main="cisTopic 5000",pch=20);legend("topright",paste0("NMI = ",round(cisTopic2_NMI,3)),box.lty=0)
plot(cisTopic3@dr$cell$Umap[,1], cisTopic3@dr$cell$Umap[,2], xlab="UMAP_1", ylab="UMAP_2", col=cisTopic3_col,main="cisTopic 2500",pch=20);legend("topright",paste0("NMI = ",round(cisTopic3_NMI,3)),box.lty=0)
plot(cisTopic4@dr$cell$Umap[,1], cisTopic4@dr$cell$Umap[,2], xlab="UMAP_1", ylab="UMAP_2", col=cisTopic4_col,main="cisTopic 1000",pch=20);legend("topright",paste0("NMI = ",round(cisTopic4_NMI,3)),box.lty=0)
legend(par('usr')[2]+0.1, par('usr')[4], bty='n', xpd=NA, legend=celltypename, pch=20, col=clusters, box.lty=0)
dev.off()

scABC1 <- readRDS('clustering_benchmark_methods_simulated_data/scABC/10000_merged_scABC_umap.rds');scABC1_cluster <- readRDS('scABC/10000_merged_scABC_cluster.rds')
scABC2 <- readRDS('clustering_benchmark_methods_simulated_data/scABC/5000_merged_scABC_umap.rds');scABC2_cluster <- readRDS('scABC/5000_merged_scABC_cluster.rds')
scABC3 <- readRDS('clustering_benchmark_methods_simulated_data/scABC/2500_merged_scABC_umap.rds');scABC3_cluster <- readRDS('scABC/2500_merged_scABC_cluster.rds')
scABC4 <- readRDS('clustering_benchmark_methods_simulated_data/scABC/1000_merged_scABC_umap.rds');scABC4_cluster <- readRDS('scABC/1000_merged_scABC_cluster.rds')
scABC1_col <- plyr::mapvalues(x = gsub("\\_.*","",names(scABC1_cluster)), from = celltype, to = clusters)
scABC2_col <- plyr::mapvalues(x = gsub("\\_.*","",names(scABC2_cluster)), from = celltype, to = clusters)
scABC3_col <- plyr::mapvalues(x = gsub("\\_.*","",names(scABC3_cluster)), from = celltype, to = clusters)
scABC4_col <- plyr::mapvalues(x = gsub("\\_.*","",names(scABC4_cluster)), from = celltype, to = clusters)
scABC1_NMI <- NMI(gsub("\\_.*","",names(scABC1_cluster)),as.numeric(scABC1_cluster)) 
scABC2_NMI <- NMI(gsub("\\_.*","",names(scABC2_cluster)),as.numeric(scABC2_cluster))
scABC3_NMI <- NMI(gsub("\\_.*","",names(scABC3_cluster)),as.numeric(scABC3_cluster))
scABC4_NMI <- NMI(gsub("\\_.*","",names(scABC4_cluster)),as.numeric(scABC4_cluster))
pdf("NMI_scABC.pdf",width=13,height=3.25)
par(mfrow=c(1,4),omi=c(0.05,0.1,0.05,1))
plot(scABC1[,1], scABC1[,2], xlab="UMAP_1", ylab="UMAP_2", col=scABC1_col,main="scABC 10000",pch=20);legend("topright",paste0("NMI = ",round(scABC1_NMI,3)),box.lty=0)
plot(scABC2[,1], scABC2[,2], xlab="UMAP_1", ylab="UMAP_2", col=scABC2_col,main="scABC 5000",pch=20);legend("topright",paste0("NMI = ",round(scABC2_NMI,3)),box.lty=0)
plot(scABC3[,1], scABC3[,2], xlab="UMAP_1", ylab="UMAP_2", col=scABC3_col,main="scABC 2500",pch=20);legend("topright",paste0("NMI = ",round(scABC3_NMI,3)),box.lty=0)
plot(scABC4[,1], scABC4[,2], xlab="UMAP_1", ylab="UMAP_2", col=scABC4_col,main="scABC 1000",pch=20);legend("topright",paste0("NMI = ",round(scABC4_NMI,3)),box.lty=0)
legend(par('usr')[2]+0.1, par('usr')[4], bty='n', xpd=NA, legend=celltypename, pch=20, col=clusters, box.lty=0)
dev.off()

snapATAC1 <- readRDS('clustering_benchmark_methods_simulated_data/snapATAC/10000_merged_snapATAC_umap.rds');snapATAC1_cluster <- readRDS('snapATAC/10000_merged_snapATAC_cluster.rds')
snapATAC2 <- readRDS('clustering_benchmark_methods_simulated_data/snapATAC/5000_merged_snapATAC_umap.rds');snapATAC2_cluster <- readRDS('snapATAC/5000_merged_snapATAC_cluster.rds')
snapATAC3 <- readRDS('clustering_benchmark_methods_simulated_data/snapATAC/2500_merged_snapATAC_umap.rds');snapATAC3_cluster <- readRDS('snapATAC/2500_merged_snapATAC_cluster.rds')
snapATAC4 <- readRDS('clustering_benchmark_methods_simulated_data/snapATAC/1000_merged_snapATAC_umap.rds');snapATAC4_cluster <- readRDS('snapATAC/1000_merged_snapATAC_cluster.rds')
snapATAC1_col <- plyr::mapvalues(x = gsub("\\_.*","",names(snapATAC1_cluster)), from = celltype, to = clusters)
snapATAC2_col <- plyr::mapvalues(x = gsub("\\_.*","",names(snapATAC2_cluster)), from = celltype, to = clusters)
snapATAC3_col <- plyr::mapvalues(x = gsub("\\_.*","",names(snapATAC3_cluster)), from = celltype, to = clusters)
snapATAC4_col <- plyr::mapvalues(x = gsub("\\_.*","",names(snapATAC4_cluster)), from = celltype, to = clusters)
snapATAC1_NMI <- NMI(gsub("\\_.*","",names(snapATAC1_cluster)),as.numeric(snapATAC1_cluster)) 
snapATAC2_NMI <- NMI(gsub("\\_.*","",names(snapATAC2_cluster)),as.numeric(snapATAC2_cluster))
snapATAC3_NMI <- NMI(gsub("\\_.*","",names(snapATAC3_cluster)),as.numeric(snapATAC3_cluster))
snapATAC4_NMI <- NMI(gsub("\\_.*","",names(snapATAC4_cluster)),as.numeric(snapATAC4_cluster))
pdf("NMI_snapATAC.pdf",width=13,height=3.25)
par(mfrow=c(1,4),omi=c(0.05,0.1,0.05,1))
plot(snapATAC1[,1], snapATAC1[,2], xlab="UMAP_1", ylab="UMAP_2", col=snapATAC1_col,main="snapATAC 10000",pch=20);legend("topright",paste0("NMI = ",round(snapATAC1_NMI,3)),box.lty=0)
plot(snapATAC2[,1], snapATAC2[,2], xlab="UMAP_1", ylab="UMAP_2", col=snapATAC2_col,main="snapATAC 5000",pch=20);legend("topright",paste0("NMI = ",round(snapATAC2_NMI,3)),box.lty=0)
plot(snapATAC3[,1], snapATAC3[,2], xlab="UMAP_1", ylab="UMAP_2", col=snapATAC3_col,main="snapATAC 2500",pch=20);legend("topright",paste0("NMI = ",round(snapATAC3_NMI,3)),box.lty=0)
plot(snapATAC4[,1], snapATAC4[,2], xlab="UMAP_1", ylab="UMAP_2", col=snapATAC4_col,main="snapATAC 1000",pch=20);legend("topright",paste0("NMI = ",round(snapATAC4_NMI,3)),box.lty=0)
legend(par('usr')[2]+0.1, par('usr')[4], bty='n', xpd=NA, legend=celltypename, pch=20, col=clusters, box.lty=0)
dev.off()
